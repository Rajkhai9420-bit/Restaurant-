<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restaurant Management System</title>
  <style>
    :root{
      --bg:#071022;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#ff6b35;
      --radius:12px;
      font-family: Inter, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,#071022 0%,#081627 100%);
      color:#e6eef6;
    }

    .container{
      width:95%;
      max-width:980px;
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
    }

    h1,h2,h3{color:var(--accent); margin:6px 0 16px; text-align:center;}
    .top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .left, .right{flex:1}

    .panel { background:#071326; padding:16px; border-radius:10px; max-width:480px; margin:0 auto; }
    label{display:block;color:var(--muted); font-size:13px; margin-bottom:6px;margin-top:10px}
    input, select, textarea, button { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03); color:#fff; font-size:14px }
    textarea{min-height:80px; resize:vertical}
    .btn{background:var(--accent); border:none; color:#fff; cursor:pointer; font-weight:700; transition:all 0.2s}
    .btn:hover{background:#ff8555;transform:translateY(-1px)}
    .btn.secondary{background:#374151}
    .btn.secondary:hover{background:#4b5563}
    .small{padding:8px;font-size:14px}
    .btn:disabled{opacity:0.5;cursor:not-allowed}

    .menu-bar{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:14px}
    .menu-item{background:#0f1a2b;padding:10px 14px;border-radius:10px;cursor:pointer;text-align:center;width:140px;transition:all 0.2s}
    .menu-item:hover{background:#1a2638;transform:translateY(-2px)}
    .menu-item img{width:44px;height:44px;display:block;margin:0 auto 8px;border-radius:8px}
    .content{background:#071a2b;padding:14px;border-radius:10px; color:#e6eef6}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th, td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03); text-align:left}
    th{color:var(--accent)}

    .list-rest { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .rest-card { background:#0f1a2b;padding:10px;border-radius:10px; display:flex; gap:10px; align-items:center; cursor:pointer; transition:all 0.2s}
    .rest-card:hover{background:#1a2638;transform:translateY(-2px)}
    .rest-card img { width:64px;height:64px;border-radius:8px; object-fit:cover }

    .dish-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px; }
    .dish-card { background:#0f1a2b; border-radius:10px; overflow:hidden; display:flex; flex-direction:column; transition:all 0.2s}
    .dish-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.3)}
    .dish-card img { width:100%; height:140px; object-fit:cover; display:block; }
    .dish-card .info { padding:10px; display:flex; flex-direction:column; gap:6px; }
    .dish-name { font-weight:700; }
    .dish-meta { color:var(--muted); font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    .order-count { font-size:12px; color: #cbd5e1; }

    .back { margin-top:14px; background:#374151; }
    .loading{text-align:center;color:var(--muted);padding:20px}
    .error{color:#ff6b6b;background:rgba(255,107,107,0.1);padding:10px;border-radius:6px;margin:10px 0}
    .success{color:#51cf66;background:rgba(81,207,102,0.1);padding:10px;border-radius:6px;margin:10px 0}
    
    @media (max-width:700px){ 
      .menu-item{width:110px} 
      .rest-card{flex-direction:column; align-items:flex-start}
      .top-row{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <div class="container" id="app">

    <div class="top-row">
      <div><h1>üçΩÔ∏è Spice & Flavor</h1></div>
      <div id="top-actions" class="flex"></div>
    </div>

    <div id="auth-area" class="panel">
      <div id="login-view">
        <h2>Login</h2>
        <label>Email</label><input id="login-email" placeholder="you@example.com" type="email">
        <label>Password</label><input id="login-password" type="password" placeholder="password">
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn" id="login-btn">Login</button>
          <button class="btn secondary" id="show-register">Register</button>
        </div>
        <p style="color:var(--muted); margin-top:14px; font-size:13px">üí° Restaurant accounts can manage menus & orders. User accounts can browse & order.</p>
      </div>

      <div id="register-view" style="display:none;">
        <h2>Register</h2>
        <label>Account Type</label>
        <select id="reg-type">
          <option value="user">User (Customer)</option>
          <option value="restaurant">Restaurant (Owner)</option>
        </select>
        <label>Name</label><input id="reg-name" placeholder="Your name / Restaurant name">
        <label>Email</label><input id="reg-email" placeholder="you@example.com" type="email">
        <label>Password</label><input id="reg-password" type="password">
        <label>Confirm Password</label><input id="reg-confirm" type="password">
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn" id="register-btn">Register</button>
          <button class="btn secondary" id="show-login">Back to Login</button>
        </div>
      </div>
    </div>

    <div id="restaurant-dashboard" style="display:none">
      <div class="top-row">
        <div><h2 id="rest-title">Restaurant Dashboard</h2></div>
        <div class="flex">
          <button class="btn small" id="rest-home-btn">Dashboard</button>
          <button class="btn small secondary" id="rest-logout">Logout</button>
        </div>
      </div>

      <div class="menu-bar" id="rest-menu">
        <div class="menu-item" data-sec="manage-menu"><img src="https://cdn-icons-png.flaticon.com/512/2921/2921820.png"><div>Menu</div></div>
        <div class="menu-item" data-sec="manage-tables"><img src="https://cdn-icons-png.flaticon.com/512/1046/1046784.png"><div>Tables</div></div>
        <div class="menu-item" data-sec="manage-income"><img src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png"><div>Income</div></div>
        <div class="menu-item" data-sec="manage-feedback"><img src="https://cdn-icons-png.flaticon.com/512/2462/2462719.png"><div>Feedback</div></div>
        <div class="menu-item" data-sec="manage-orders"><img src="https://cdn-icons-png.flaticon.com/512/2830/2830308.png"><div>Orders</div></div>
      </div>

      <div class="content" id="rest-content">
        <h3>Welcome ‚Äî manage your restaurant from here</h3>
        <p style="color:var(--muted)">Choose one of the tiles above to add menu items, tables, view income and customer feedback.</p>
      </div>
    </div>

    <div id="user-dashboard" style="display:none">
      <div class="top-row">
        <div><h2 id="user-title">User Panel</h2></div>
        <div class="flex">
          <button class="btn small" id="user-home-btn">Home</button>
          <button class="btn small secondary" id="user-logout-btn">Logout</button>
        </div>
      </div>

      <div class="content" id="user-content">
        <h3>Choose a restaurant to visit</h3>
        <div id="restaurant-list" class="list-rest" style="margin-top:12px;"></div>
      </div>
    </div>

  </div>

<script>
const API_BASE_URL = 'http://localhost:5000/api';

async function apiCall(endpoint, method = 'GET', data = null) {
  const options = {
    method,
    headers: {'Content-Type': 'application/json'}
  };
  if (data) options.body = JSON.stringify(data);

  try {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Request failed');
    return result;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

let currentAccount = null;
let currentRestaurantId = null;
let currentRestaurantData = null;
const sessionCart = {};

const authArea = document.getElementById('auth-area');
const loginView = document.getElementById('login-view');
const registerView = document.getElementById('register-view');
const restaurantDashboard = document.getElementById('restaurant-dashboard');
const restContent = document.getElementById('rest-content');
const restTitle = document.getElementById('rest-title');
const userDashboard = document.getElementById('user-dashboard');
const userContent = document.getElementById('user-content');
const restaurantListEl = document.getElementById('restaurant-list');

document.getElementById('show-register').addEventListener('click', e=>{
  e.preventDefault();
  loginView.style.display='none';
  registerView.style.display='block';
});

document.getElementById('show-login').addEventListener('click', e=>{
  e.preventDefault();
  registerView.style.display='none';
  loginView.style.display='block';
});

document.getElementById('register-btn').addEventListener('click', async ()=>{
  const btn = document.getElementById('register-btn');
  btn.disabled = true;

  try {
    const type = document.getElementById('reg-type').value;
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-password').value;
    const confirm = document.getElementById('reg-confirm').value;

    if(!name || !email || !pass || !confirm){ 
      alert('Please fill all fields'); 
      return; 
    }
    if(pass !== confirm){ 
      alert('Passwords do not match'); 
      return; 
    }
    if(pass.length < 6){
      alert('Password must be at least 6 characters');
      return;
    }

    await apiCall('/register', 'POST', { type, name, email, password: pass });

    alert('‚úì Registration successful! You can now login.');
    registerView.style.display='none';
    loginView.style.display='block';

    document.getElementById('reg-name').value = '';
    document.getElementById('reg-email').value = '';
    document.getElementById('reg-password').value = '';
    document.getElementById('reg-confirm').value = '';
  } catch (error) {
    alert('Registration failed: ' + error.message);
  } finally {
    btn.disabled = false;
  }
});

document.getElementById('login-btn').addEventListener('click', async ()=>{
  const btn = document.getElementById('login-btn');
  btn.disabled = true;

  try {
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;

    if(!email || !pass){ 
      alert('Please enter credentials'); 
      return; 
    }

    const account = await apiCall('/login', 'POST', { email, password: pass });
    currentAccount = account;
    authArea.style.display = 'none';

    if(account.type === 'restaurant'){
      await loadRestaurantDashboard(account.restaurantId);
      restaurantDashboard.style.display = 'block';
      restTitle.textContent = 'üìä ' + account.name;
    } else {
      await showRestaurantSelection();
      userDashboard.style.display = 'block';
      document.getElementById('user-title').textContent = `Welcome, ${account.name}`;
    }
  } catch (error) {
    alert('Login failed: ' + error.message);
  } finally {
    btn.disabled = false;
  }
});

document.getElementById('rest-logout').addEventListener('click', ()=>{
  currentAccount = null;
  currentRestaurantData = null;
  restaurantDashboard.style.display = 'none';
  authArea.style.display = 'block';
});

document.getElementById('user-logout-btn').addEventListener('click', ()=>{
  currentAccount = null;
  userDashboard.style.display = 'none';
  authArea.style.display = 'block';
});

document.getElementById('rest-home-btn').addEventListener('click', ()=>{
  restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to manage menu, tables, income and view feedback.</p>`;
});

document.getElementById('user-home-btn').addEventListener('click', ()=>{
  showRestaurantSelection();
});

document.querySelectorAll('#rest-menu .menu-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    const sec = item.getAttribute('data-sec');
    if(sec === 'manage-menu') showManageMenu();
    if(sec === 'manage-tables') showManageTables();
    if(sec === 'manage-income') showManageIncome();
    if(sec === 'manage-feedback') showManageFeedback();
    if(sec === 'manage-orders') showManageOrders();
  });
});

async function loadRestaurantDashboard(restaurantId){
  try {
    currentRestaurantData = await apiCall(`/restaurants/${restaurantId}`);
    restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to add menu items, tables, income and see feedback.</p>`;
  } catch (error) {
    restContent.innerHTML = `<p class="error">Error loading restaurant data: ${error.message}</p>`;
  }
}

async function showManageMenu(){
  try {
    const rest = await apiCall(`/restaurants/${currentAccount.restaurantId}`);
    currentRestaurantData = rest;

    restContent.innerHTML = `
      <h3>Menu ‚Äî ${rest.name}</h3>
      <label>Dish name</label><input id="dish-name" placeholder="e.g., Masala Dosa">
      <label>Price (‚Çπ)</label><input id="dish-price" type="number" placeholder="120">
      <label>Image URL (optional)</label><input id="dish-img" placeholder="https://...">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="add-dish-btn">Add Dish</button>
        <button class="btn secondary back" id="menu-back">Back</button>
      </div>
      <table>
        <thead><tr><th>Dish</th><th>Price</th><th>Orders</th><th>Image</th></tr></thead>
        <tbody id="menu-table">${rest.menu.map(m=>`<tr><td>${escapeHtml(m.name)}</td><td>‚Çπ${m.price}</td><td>${m.orderCount||0}</td><td><img src="${m.img}" style="width:80px;height:50px;object-fit:cover;border-radius:6px"></td></tr>`).join('')}</tbody>
      </table>
    `;

    document.getElementById('add-dish-btn').addEventListener('click', async ()=>{
      const btn = document.getElementById('add-dish-btn');
      btn.disabled = true;
      try {
        const name = document.getElementById('dish-name').value.trim();
        const price = document.getElementById('dish-price').value.trim();
        const img = document.getElementById('dish-img').value.trim();
        if(!name || !price) { alert('Enter name and price'); return; }
        await apiCall(`/restaurants/${currentAccount.restaurantId}/menu`, 'POST', {name, price: Number(price), img});
        alert('‚úì Dish added successfully!');
        showManageMenu();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('menu-back').addEventListener('click', ()=>{
      restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above.</p>`;
    });
  } catch (error) {
    restContent.innerHTML = `<p class="error">Error: ${error.message}</p>`;
  }
}

async function showManageTables(){
  try {
    const rest = await apiCall(`/restaurants/${currentAccount.restaurantId}`);
    currentRestaurantData = rest;

    restContent.innerHTML = `
      <h3>Tables ‚Äî ${rest.name}</h3>
      <label>Table number</label><input id="table-num" placeholder="e.g., 1">
      <label>Status</label>
      <select id="table-status"><option>Available</option><option>Booked</option><option>Occupied</option></select>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="add-table-btn">Add / Update Table</button>
        <button class="btn secondary back" id="tables-back">Back</button>
      </div>
      <table>
        <thead><tr><th>Table</th><th>Status</th></tr></thead>
        <tbody id="tables-list">${rest.tables.map(t=>`<tr><td>${t.num}</td><td>${t.status}</td></tr>`).join('')}</tbody>
      </table>
      <h4 style="margin-top:14px">Bookings</h4>
      <table>
        <thead><tr><th>Table</th><th>When</th><th>By</th></tr></thead>
        <tbody>${(rest.bookings||[]).map(b=>`<tr><td>${b.tableNum}</td><td>${b.start} ‚Üí ${b.end}</td><td>${escapeHtml(b.userName)}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--muted)">No bookings</td></tr>'}</tbody>
      </table>
    `;

    document.getElementById('add-table-btn').addEventListener('click', async ()=>{
      const btn = document.getElementById('add-table-btn');
      btn.disabled = true;
      try {
        const num = document.getElementById('table-num').value.trim();
        const status = document.getElementById('table-status').value;
        if(!num) { alert('Enter table number'); return; }
        await apiCall(`/restaurants/${currentAccount.restaurantId}/tables`, 'POST', {num, status});
        alert('‚úì Table updated successfully!');
        showManageTables();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('tables-back').addEventListener('click', ()=>{
      restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above.</p>`;
    });
  } catch (error) {
    restContent.innerHTML = `<p class="error">Error: ${error.message}</p>`;
  }
}

async function showManageIncome(){
  try {
    const rest = await apiCall(`/restaurants/${currentAccount.restaurantId}`);
    currentRestaurantData = rest;
    const total = (rest.incomes || []).reduce((a,b)=>a+b,0);
    
    restContent.innerHTML = `
      <h3>Income ‚Äî ${rest.name}</h3>
      <label>Amount (‚Çπ)</label><input id="income-amt" type="number" placeholder="200">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="add-income-btn">Add Income</button>
        <button class="btn secondary back" id="income-back">Back</button>
      </div>
      <h4 style="margin-top:12px">Total Revenue: ‚Çπ${total.toFixed(2)}</h4>
      <ul>${(rest.incomes||[]).map(i=>`<li>‚Çπ${i}</li>`).join('') || '<li style="color:var(--muted)">No income entries</li>'}</ul>
    `;

    document.getElementById('add-income-btn').addEventListener('click', async ()=>{
      const btn = document.getElementById('add-income-btn');
      btn.disabled = true;
      try {
        const v = Number(document.getElementById('income-amt').value);
        if(isNaN(v) || v<=0) { alert('Enter a valid amount'); return; }
        await apiCall(`/restaurants/${currentAccount.restaurantId}/income`, 'POST', {amount: v});
        alert('‚úì Income added successfully!');
        showManageIncome();
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('income-back').addEventListener('click', ()=>{
      restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above.</p>`;
    });
  } catch (error) {
    restContent.innerHTML = `<p class="error">Error: ${error.message}</p>`;
  }
}

async function showManageFeedback(){
  try {
    const rest = await apiCall(`/restaurants/${currentAccount.restaurantId}`);
    currentRestaurantData = rest;

    restContent.innerHTML = `
      <h3>Feedback ‚Äî ${rest.name}</h3>
      <ul>
        ${(rest.feedback || []).map(f=>`
          <li style="margin-bottom:10px;">
            <strong>${escapeHtml(f.userName)}</strong> (${new Date(f.when).toLocaleString()})
            <br>
            <span style="color:#ffb703;">Food: ${'‚òÖ'.repeat(f.foodRating||0)}${'‚òÜ'.repeat(5-(f.foodRating||0))}</span>
            &nbsp;&nbsp;
            <span style="color:#ffb703;">Service: ${'‚òÖ'.repeat(f.serviceRating||0)}${'‚òÜ'.repeat(5-(f.serviceRating||0))}</span>
            <br>
            <span style="color:#cbd5e1;">${escapeHtml(f.text)}</span>
          </li>
        `).join('') || '<li style="color:var(--muted)">No feedback yet</li>'}
      </ul>
      <button class="btn secondary back" id="feedback-back">Back</button>
    `;

    document.getElementById('feedback-back').addEventListener('click', ()=> {
      restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above.</p>`;
    });
  } catch (error) {
    restContent.innerHTML = `<p class="error">Error: ${error.message}</p>`;
  }
}

async function showManageOrders(){
  try {
    const rest = await apiCall(`/restaurants/${currentAccount.restaurantId}`);
    currentRestaurantData = rest;

    restContent.innerHTML = `<h3>Orders ‚Äî ${rest.name}</h3>`;
    if(!rest.orders || !rest.orders.length){
      restContent.innerHTML += `<p style="color:var(--muted)">No orders yet.</p>`;
      restContent.innerHTML += `<button class="btn secondary back" id="orders-back">Back</button>`;
      document.getElementById('orders-back').addEventListener('click', ()=> {
        restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above.</p>`;
      });
      return;
    }

    restContent.innerHTML += `
      <table>
        <thead><tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Method</th><th>When</th></tr></thead>
        <tbody>
          ${rest.orders.map(o=>`<tr>
            <td>${o.id}</td>
            <td>${escapeHtml(o.userName)}</td>
            <td>${o.items.map(it=>escapeHtml(it.name)+' √ó'+(it.qty||1)).join('<br>')}</td>
            <td>‚Çπ${o.total}</td>
            <td>${o.method}</td>
            <td>${new Date(o.when).toLocaleString()}</td>
          </tr>`).join('')}
        </tbody>
      </table>
      <button class="btn secondary back" style="margin-top:14px" id="orders-back">Back</button>
    `;
    
    document.getElementById('orders-back').addEventListener('click', ()=> {
      restContent.innerHTML = `<h3>Welcome ‚Äî manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above.</p>`;
    });
  } catch (error) {
    restContent.innerHTML = `<p class="error">Error: ${error.message}</p>`;
  }
}

async function showRestaurantSelection(){
  try {
    userContent.innerHTML = `<div class="loading">Loading restaurants...</div>`;
    const restaurants = await apiCall('/restaurants');

    userContent.innerHTML = `<h3>Pick a restaurant to visit</h3><div id="rest-list-grid" class="list-rest"></div>`;
    const grid = document.getElementById('rest-list-grid');

    if(!restaurants.length){
      grid.innerHTML = `<div style="padding:14px;color:var(--muted)">No restaurants registered yet.</div>`;
      return;
    }

    grid.innerHTML = restaurants.map(r => {
      return `<div class="rest-card" data-rid="${r.id}">
        <img src="${r.logo}" alt="logo">
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(r.name)}</div>
          <div style="color:var(--muted);font-size:13px">${r.menuCount||0} dishes ¬∑ ${r.tableCount||0} tables</div>
        </div>
        <div style="text-align:right">
          <button class="btn small" data-visit="${r.id}">Visit</button>
        </div>
      </div>`;
    }).join('');

    grid.querySelectorAll('[data-visit]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const rid = btn.getAttribute('data-visit');
        visitRestaurant(rid);
      });
    });
  } catch (error) {
    userContent.innerHTML = `<p class="error">Error loading restaurants: ${error.message}</p>`;
  }
}

async function visitRestaurant(restaurantId){
  try {
    currentRestaurantId = restaurantId;
    userContent.innerHTML = `<div class="loading">Loading restaurant...</div>`;
    const rest = await apiCall(`/restaurants/${restaurantId}`);

    userContent.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
        <div style="display:flex;gap:10px;align-items:center">
          <img src="${rest.logo}" style="width:64px;height:64px;border-radius:8px;object-fit:cover">
          <div>
            <h3 style="margin:0">${escapeHtml(rest.name)}</h3>
            <div style="color:var(--muted);font-size:13px">${rest.menu?.length||0} dishes ¬∑ ${rest.tables?.length||0} tables</div>
          </div>
        </div>
        <button class="btn small" id="back-to-list">‚Üê Back</button>
      </div>

      <div style="margin-top:12px" id="visit-tabs">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn small" id="visit-menu-btn">Menu</button>
          <button class="btn small secondary" id="visit-book-btn">Book Table</button>
          <button class="btn small secondary" id="visit-pay-btn">Cart & Payment</button>
          <button class="btn small secondary" id="visit-feedback-btn">Feedback</button>
        </div>
        <div id="visit-area" style="background:#071a2b;padding:12px;border-radius:8px"></div>
      </div>
    `;

    document.getElementById('back-to-list').addEventListener('click', ()=> showRestaurantSelection());
    document.getElementById('visit-menu-btn').addEventListener('click', ()=> renderVisitMenu(rest));
    document.getElementById('visit-book-btn').addEventListener('click', ()=> renderVisitBooking(rest));
    document.getElementById('visit-pay-btn').addEventListener('click', ()=> renderVisitPayment(rest));
    document.getElementById('visit-feedback-btn').addEventListener('click', ()=> renderVisitFeedback(rest));

    renderVisitMenu(rest);

    function renderVisitMenu(restObj){
      const area = document.getElementById('visit-area');
      if(!restObj.menu || !restObj.menu.length){
        area.innerHTML = `<div style="color:var(--muted)">No menu items available.</div>`;
        return;
      }
      area.innerHTML = `<h4>Browse Menu</h4><div class="dish-grid">${restObj.menu.map(m=>`<div class="dish-card"><img src="${m.img}"><div class="info"><div class="dish-name">${escapeHtml(m.name)}</div><div class="dish-meta"><div>‚Çπ${m.price}</div><div class="order-count">${m.orderCount||0} orders</div></div><div><button class="btn small" data-add="${m.id}">Add to Cart</button></div></div></div>`).join('')}</div>`;
      area.querySelectorAll('[data-add]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.getAttribute('data-add');
          if(!sessionCart[restObj.id]) sessionCart[restObj.id] = [];
          const menuItem = restObj.menu.find(x=>String(x.id)===String(id));
          const existing = sessionCart[restObj.id].find(it=>String(it.id)===String(id));
          if(existing) existing.qty = (existing.qty || 1) + 1;
          else sessionCart[restObj.id].push({id: menuItem.id, name: menuItem.name, price: menuItem.price, qty: 1});
          alert('‚úì Added to cart!');
        });
      });
    }

    function renderVisitBooking(restObj){
      const area = document.getElementById('visit-area');
      if(!restObj.tables || !restObj.tables.length){
        area.innerHTML = `<div style="color:var(--muted)">No tables available for booking.</div>`;
        return;
      }
      area.innerHTML = `<h4>Book a Table</h4>
        <label>Your name</label><input id="bk-name" placeholder="Enter your name">
        <label>Select Table</label><select id="bk-table">${(restObj.tables||[]).map(t=>`<option value="${t.id}">Table ${t.num} (${t.status})</option>`).join('')}</select>
        <label>From (e.g., 2025-11-22 19:00)</label><input id="bk-start" placeholder="YYYY-MM-DD HH:MM">
        <label>To</label><input id="bk-end" placeholder="YYYY-MM-DD HH:MM">
        <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="bk-btn">Book Table</button></div>`;
      document.getElementById('bk-btn').addEventListener('click', ()=>{
        const name = document.getElementById('bk-name').value.trim();
        const tableId = document.getElementById('bk-table').value;
        const start = document.getElementById('bk-start').value.trim();
        const end = document.getElementById('bk-end').value.trim();
        if(!name || !tableId || !start || !end){ alert('Please fill all fields'); return; }
        alert('‚úì Booking request submitted! (Demo mode - backend booking endpoint not fully implemented)');
      });
    }

    function renderVisitPayment(restObj){
      const area = document.getElementById('visit-area');
      const cart = sessionCart[restObj.id] || [];
      if(!cart.length) { 
        area.innerHTML = `<div style="color:var(--muted);text-align:center;padding:20px">üõí Your cart is empty<br><small>Add items from the menu first</small></div>`; 
        return; 
      }
      const total = cart.reduce((s,i)=>s+i.price*(i.qty||1),0);
      area.innerHTML = `<h4>Your Cart</h4>
        <table>
          <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr></thead>
          <tbody>${cart.map(it=>`<tr><td>${escapeHtml(it.name)}</td><td>‚Çπ${it.price}</td><td>${it.qty}</td><td>‚Çπ${it.price * it.qty}</td></tr>`).join('')}</tbody>
        </table>
        <h4 style="margin-top:14px">Total: ‚Çπ${total.toFixed(2)}</h4>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="pay-btn">Place Order & Pay</button>
          <button class="btn secondary" id="clear-cart">Clear Cart</button>
        </div>`;
      
      document.getElementById('pay-btn').addEventListener('click', async ()=>{
        const btn = document.getElementById('pay-btn');
        btn.disabled = true;
        try {
          const resp = await apiCall(`/restaurants/${restObj.id}/orders`, 'POST', { 
            userName: (currentAccount && currentAccount.name) || 'Guest', 
            items: cart, 
            total, 
            method: 'online' 
          });
          alert('‚úì Order placed successfully! Order ID: ' + resp.orderId);
          sessionCart[restObj.id] = [];
          renderVisitPayment(restObj);
        } catch (err) {
          alert('Payment failed: ' + err.message);
        } finally {
          btn.disabled = false;
        }
      });
      
      document.getElementById('clear-cart').addEventListener('click', ()=>{
        sessionCart[restObj.id] = [];
        renderVisitPayment(restObj);
      });
    }

    function renderVisitFeedback(restObj){
      const area = document.getElementById('visit-area');
      area.innerHTML = `<h4>Leave Feedback</h4>
        <label>Your name</label><input id="fb-name" placeholder="Your name">
        <label>Food Rating</label>
        <select id="fb-food"><option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Very Good</option><option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Good</option><option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Fair</option><option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Poor</option></select>
        <label>Service Rating</label>
        <select id="fb-service"><option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Very Good</option><option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Good</option><option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Fair</option><option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Poor</option></select>
        <label>Comments</label><textarea id="fb-text" placeholder="Share your experience..."></textarea>
        <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="fb-btn">Submit Feedback</button></div>`;
      
      document.getElementById('fb-btn').addEventListener('click', async ()=>{
        const btn = document.getElementById('fb-btn');
        btn.disabled = true;
        try {
          const name = document.getElementById('fb-name').value.trim() || 'Anonymous';
          const food = document.getElementById('fb-food').value;
          const service = document.getElementById('fb-service').value;
          const text = document.getElementById('fb-text').value.trim();
          
          await apiCall(`/restaurants/${restObj.id}/feedback`, 'POST', {
            userName: name,
            foodRating: parseInt(food),
            serviceRating: parseInt(service),
            text: text
          });
          
          alert('‚úì Thank you for your feedback!');
          document.getElementById('fb-name').value = '';
          document.getElementById('fb-text').value = '';
        } catch (err) {
          alert('Error submitting feedback: ' + err.message);
        } finally {
          btn.disabled = false;
        }
      });
    }
  } catch (error) {
    userContent.innerHTML = `<p class="error">Error loading restaurant: ${error.message}</p>`;
  }
}

function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
}
</script>

</body>
</html>